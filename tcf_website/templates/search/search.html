{% extends "base/base.html" %}
{% load static %}
{% load url_utils %}

{% block title %}{{query}} - theCourseForum{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'search/search.css' %}"/>
{% endblock %}

{% block content %}
    <div class="search container px-5">
      {% include "../common/leaderboard_ad.html" with ad_slot="2263598815" %}

      <div class="search-title row p-4">
        <h2>
          Search results 
          {% if query %}
            - <b><i>{{ query }}</i></b>
          {% endif %}
        </h2>
      </div>

      <div class="search-results container p-5">

        <!-- Tabs for displaying result categories: Courses, Departments, Instructors -->
        <div id="result-nav" class="result-nav row mb-5">
          <div class="col-12">
            <div class="btn-group btn-group-sm" role="toolbar">
              <a class="btn bg-tcf-indigo text-white" disabled>See results for</a>
              <a href="#courses" id="course-tab" class="btn btn-light collapsed" {% if courses_first %} autofocus {% endif %}
                 role="button" data-toggle="collapse" aria-expanded="true" aria-controls="courses">
                 Courses</a>
              <a href="#instructors" id="instructor-tab" class="btn btn-light collapsed" {% if not courses_first %} autofocus {% endif %}
                 role="button" data-toggle="collapse" aria-expanded="false" aria-controls="instructors">
                 Instructors</a>
              <a href="#departments" id="department-tab" class="btn btn-light collapsed"
                role="button" data-toggle="collapse" aria-expanded="false" aria-controls="departments">
                 Departments</a>
            </div>
          </div>
        </div>

        <!-- The current result category that is displayed -->
        <div id="results" class="accordion">

          <!-- Course results -->

          <div id="courses" class="row mb-5 collapse {% if courses_first %} show {% endif %}"
               aria-labelledby="course-tab" data-parent="#results">
            <div class="col-12">

              <div class="search-result-header mb-3">
                <h3 class="mr-3">Courses</h3>
                {% if courses %}
                <p class="text-muted">{{ total_courses }} results</p>
                {% else %}
                <p class="text-muted">0 results</p>
                {% endif %}
              </div>

              {% if courses %}
                {% for dept, dept_data in courses.items %}
                <div class="row mb-5">
                  <div class="col-12">
                    <h5><a href="{% url 'department' dept_id=dept_data.dept_id %}">{{ dept }} / {{ dept_data.subdept_name }}</a></h5>
                      {% for c in dept_data.courses %}
                        {% if c != dept_data.courses.0 %}
                        {% endif %}
                        <div class="list-group-item list-group-item-light text-dark p-2">
                          <div class="row">
                            <div class="col-md-11 align-self-center">
                                <a href="{% url 'course' mnemonic=c.mnemonic course_number=c.number %}">
                                  <div class="row g-0">
                                    <div class="col-3">{{ c.mnemonic }} {{ c.number }}</div>
                                    <div class="col-8">{{c.title}}</div>
                                  </div>
                                </a>
                            </div>
                            <div class="col-md-1 align-self-center">
                              <h5 class="hover-tcf-orange" data-toggle="collapse"
                                data-target="#description_container_{{forloop.parentloop.counter}}_{{forloop.counter}}"
                                id="result_{{forloop.counter}}">
                                <i class="fas fa-chevron-down" style="vertical-align: middle;"></i>
                              </h5>
                            </div>
                          </div>
                          <div class="collapse" id="description_container_{{forloop.parentloop.counter}}_{{forloop.counter}}">
                            <hr>
                            <p>
                              <small class="text-uppercase search-course-description" style="font-size: 15px;">
                                Course Description:
                              </small>
                              {% if c.description|length > 0 %}
                                {{c.description}}
                              {%else%}
                                N/A
                              {%endif%}
                            </p>
                          </div>
                        </div>
                      {% endfor %}
                  </div>
                </div>
              {% endfor %}
              <div class="pagination">
                {% if page_obj.has_previous %}
                  <a href="?{{ request|change_page:1 }}">&lt;&lt;</a>
                  <a href="?{{ request|change_page:page_obj.previous_page_number }}">&lt;</a>
                {% endif %}

                {% if page_obj.number == 1 %}
                    <span class="current">1</span>
                {% else %}
                    <a href="?{{ request|change_page:1 }}">1</a>
                {% endif %}

                {% if page_obj.number > 4 %}
                    <span class="dots">...</span>
                {% endif %}

                {% for page_num in page_obj.paginator.page_range %}
                    {% if page_num > 1 and page_num < page_obj.paginator.num_pages %}
                        {% if page_num >= page_obj.number|add:'-2' and page_num <= page_obj.number|add:'2' %}
                            {% if page_num == page_obj.number %}
                                <span class="current">{{ page_num }}</span>
                            {% else %}
                                <a href="?{{ request|change_page:page_num }}">{{ page_num }}</a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            
                {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
                    <span class="dots">...</span>
                {% endif %}
            
                {% if page_obj.paginator.num_pages > 1 %}
                    {% if page_obj.number == page_obj.paginator.num_pages %}
                        <span class="current">{{ page_obj.paginator.num_pages }}</span>
                    {% else %}
                        {% comment %} <a href="?page={{ page_obj.paginator.num_pages }}s"> {% endcomment %}
                        <a href="?{{ request|change_page:page_obj.paginator.num_pages }}">
                            {{ page_obj.paginator.num_pages }}
                        </a>
                    {% endif %}
                {% endif %}
                {% if page_obj.has_next %}
                  <a href="?{{ request|change_page:page_obj.next_page_number }}">&gt;</a>
                  <a href="?{{ request|change_page:page_obj.paginator.num_pages }}">&gt;&gt;</a>
                {% endif %}
              </div>
              {% else %}
              <p>No courses matched your search.</p>
              {% endif %}
              
            </div>
          </div>

          <!-- Instructor results -->
          <div id="instructors" class="row mb-5 collapse {% if not courses_first %} show {% endif %}"
             aria-labelledby="instructor-tab" data-parent="#results">

            <div class="col-12">
              <div class="search-result-header mb-3">
                <h3 class="mr-3">Instructors</h3>
                <p class="text-muted">{{ instructors|length }} results</p>
              </div>
              {% if instructors %}
                <ul class="list-unstyled searched-instructors text-left">
                {% for i in instructors %}
                  <li class="my-2">
                    <a href="{% url 'instructor' instructor_id=i.id %}">
                        {{ i.first_name }} {{ i.last_name }}
                    </a>
                  </li>
                {% endfor %}
                </ul>
              {% else %}
                  <p>No professors matched your search.</p>
              {% endif %}
            </div>
          </div>

          <!-- Department results -->
          <div id="departments" class="row mb-5 collapse"
               aria-labelledby="department-tab" data-parent="#results">
            <div class="col-12">

              <div class="search-result-header mb-3">
                <h3 class="mr-3">Departments</h3>
                <p class="text-muted">{{ courses|length }} results</p>
              </div>
              {% if courses %}
                <ul class="list-unstyled searched-instructors">
                {% for dept, dept_data in courses.items %}
                  <li class="my-2">
                    <a href="{% url 'department' dept_id=dept_data.dept_id %}">
                      <div class="row p-0 text-left">
                        <div class="col-sm-3">{{ dept }}</div>
                        <div class="col-sm-9">{{ dept_data.subdept_name }}</div>
                      </div>
                    </a>
                  </li>
                {% endfor %}
                </ul>
              {% else %}
                <p>No departments matched your search.</p>
              {% endif %}
            </div>
          </div>

        </div>

      </div>

    </div>
    <style>
      /* CSS for styling pagination section, copied from static/reviews/review.css */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
      }

      .pagination a,
      .pagination button, 
      .pagination span {
        font-size: 1rem;
        padding: 8px 12px;
        margin: 0 5px;
        text-decoration: none;
        color: var(--main-color);
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: background-color 0.3s, color 0.3s;
        background-color: white;
      }

      .pagination a:hover,
      .pagination button:hover {
        background-color: var(--main-color);
        color: white;
      }

      .pagination span.current {
        background-color: var(--main-color);
        color: white;
        font-weight: bold;
        border: 1px solid var(--main-color);
      }

      .pagination span {
        cursor: default;
      }

      .pagination a:disabled,
      .pagination span:disabled {
        color: #ccc;
        border-color: #ccc;
        cursor: not-allowed;
      }

      .pagination a:first-child,
      .pagination a:last-child {
        font-weight: bold;
      }

      /* Responsive styling for pagination */
      @media (max-width: 768px) {
        .pagination a,
        .pagination button {
          padding: 6px 10px;
          font-size: 0.8rem;
        }

        .page-input-wrapper {
          padding: 6px 10px;
        }
      }

      @media (max-width: 480px) {
        .pagination a,
        .pagination button,
        .pagination span {
          font-size: 0.8rem;
          padding: 4px 6px;
          margin: 0 2px;
        }
      }
    </style>
{% endblock %}

{% block js %}
  <script>

    const goButton = document.getElementById('go-to-page');

    // Prevent form submission if the page number is the same as the current page
    goButton.addEventListener('click', function(e) {
      const pageInput = document.querySelector('.page-input');
      if (parseInt(pageInput.value, 10) === {{ page_obj.number }}) {
        e.preventDefault();
      }
    });

      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".hover-tcf-orange").forEach(header => {
            header.addEventListener("click", function () {
                let icon = this.querySelector("i.fas.fa-chevron-down, i.fas.fa-chevron-up");
                console.log("Icon found:", icon);

                if (icon) {
                    icon.classList.toggle("fa-chevron-down");
                    icon.classList.toggle("fa-chevron-up");
                } else {
                    console.warn("Icon not found.");
                }
            });
        });
    });
    // Search results should display some content at all times
    // Thus the current open accordion will not be able to close itself
    $('[data-toggle="collapse"]').on('click',function(e) {
      e.preventDefault();
      if ( $(this).parents('.accordion').find('.collapse.show') ) {
        var idx = $(this).index('[data-toggle="collapse"]');
        if (idx == $('.collapse.show').index('.collapse')) {
            e.stopPropagation();
        }
      }
    });
  </script>
{% endblock %}
