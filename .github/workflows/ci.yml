# Based on https://github.com/actions/starter-workflows/blob/main/ci/django.yml
name: Continuous Integration

on:
  pull_request:
    branches:
      - "*"
  push:
    branches: [dev, master]

env:
  PYTHON_TARGET: 3.11
  DJANGO_SETTINGS_MODULE: tcf_core.settings.ci
  SECRET_KEY: ci-secret-key-not-for-production
  # CI database (GitHub Actions postgres service)
  DB_NAME: tcf_db
  DB_USER: postgres
  DB_PASSWORD: postgres
  DB_HOST: localhost
  DB_PORT: 5432

jobs:
  pylint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_TARGET }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_TARGET }}
          cache: 'pip'
          cache-dependency-path: 'requirements/*.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/ci.txt

      - name: Run pylint
        run: |
          export PYTHONPATH="$(pwd)"
          pylint --django-settings-module=${{ env.DJANGO_SETTINGS_MODULE }} --jobs=0 --load-plugins pylint_django tcf_website tcf_core

  django:
    runs-on: ubuntu-latest
    outputs:
      code-coverage: ${{ steps.coverage.outputs.percentage }}
    services:
      postgres:
        image: postgres:15.4
        env:
          POSTGRES_USER: ${{ env.DB_USER }}
          POSTGRES_PASSWORD: ${{ env.DB_PASSWORD }}
          POSTGRES_DB: ${{ env.DB_NAME }}
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_TARGET }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_TARGET }}
          cache: 'pip'
          cache-dependency-path: 'requirements/*.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/ci.txt

      - name: Migrations & Tests
        run: |
          python manage.py migrate
          curl -fsS http://localhost:8000
          coverage run manage.py test

      - name: Get code coverage
        id: coverage
        run: |
          echo "percentage=$(coverage report | grep -o '[0-9]\+%' | tail -1)" >> $GITHUB_OUTPUT

  eslint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install npm packages
        run: npm ci

      - name: Run ESLint
        run: npx eslint -c .config/.eslintrc.yml tcf_website/static/

  probe_endpoint:
    name: Endpoint probe (compose)
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4

        - name: Build & start stack
          run: |
            docker compose up -d --build

        - name: Probe endpoint
          run: |
            sleep 5
            curl -i http://localhost:8000

        - name: test app is still running
          run: curl -i localhost:3000


