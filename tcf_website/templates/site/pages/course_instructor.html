{% extends "site/base.html" %}
{% load static %}

{% block title %}{{ course.code }} | {{ instructor.full_name }} | theCourseForum{% endblock %}

{% block page_metadata %}
{% if course_code %}<meta name="course-code" content="{{ course_code }}">{% endif %}
{% if course_title %}<meta name="course-title" content="{{ course_title }}">{% endif %}
{% if instructor_fullname %}<meta name="instructor-name" content="{{ instructor_fullname }}">{% endif %}
{% if not is_current_semester %}
<meta name="robots" content="noindex">
{% endif %}
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/site/pages/course_instructor.css' %}">
<link rel="stylesheet" href="{% static 'css/site/pages/course_instructor_grades.css' %}">
{% endblock %}

{% block content %}

<!-- Header -->
<div class="course-instructor-header">
  <div class="course-instructor-header__inner">
    <!-- Breadcrumb -->
    <nav class="breadcrumb" aria-label="Breadcrumb">
      {% for crumb in breadcrumbs %}
      {% if crumb.2 %}
      <span class="breadcrumb__current">{{ crumb.0 }}</span>
      {% else %}
      <a href="{{ crumb.1 }}" class="breadcrumb__link">{{ crumb.0 }}</a>
      <span class="breadcrumb__separator">/</span>
      {% endif %}
      {% endfor %}
    </nav>
    
    <!-- Title -->
    <div class="course-instructor-title">
      <span class="course-instructor-title__code">{{ course.code }}</span>
      <span class="course-instructor-title__name">{{ course.title }}</span>
    </div>
    
    <!-- Instructor Row -->
    <div class="instructor-row">
      <div class="instructor-row__left">
        <a href="{% url 'instructor' instructor.id %}" class="instructor-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v 2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          {{ instructor.full_name }}
        </a>
      </div>
      
      <span class="semester-badge">
        Last taught: {{ semester_last_taught }}
      </span>
    </div>
  </div>
</div>

<!-- Content -->
<div class="course-instructor-content">
  <!-- Stats Grid -->
  <div class="stats-grid">
    <!-- Ratings Panel -->
    <div class="ratings-panel">
      <div class="ratings-panel__header">
        <h2 class="ratings-panel__title">Ratings</h2>
        <span class="ratings-panel__count">{{ num_ratings }} rating{{ num_ratings|pluralize }}</span>
      </div>
      
      <div id="ratings-container">
        <div class="rating-row">
          <span class="rating-row__label">Instructor</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--success instructor-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted instructor-num">—</span>
        </div>
        
        <div class="rating-row">
          <span class="rating-row__label">Enjoyability</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--success fun-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted fun-num">—</span>
        </div>
        
        <div class="rating-row">
          <span class="rating-row__label">Difficulty</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--warning difficulty-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted difficulty-num">—</span>
        </div>
        
        <div class="rating-row">
          <span class="rating-row__label">Recommend</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--success recommend-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted recommend-num">—</span>
        </div>
        
        <div class="ratings-panel__divider"></div>
        <div class="ratings-panel__subheading-row">
          <p class="ratings-panel__subheading">Weekly Breakdown</p>
          <span class="ratings-panel__hours-summary">
            <span class="ratings-panel__hours-value hours-num">—</span>
            <span class="ratings-panel__hours-unit">hrs/wk</span>
          </span>
        </div>

        <div class="rating-row rating-row--compact">
          <span class="rating-row__label">Reading</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--warning reading-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted reading-num">—</span>
        </div>

        <div class="rating-row rating-row--compact">
          <span class="rating-row__label">Writing</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--warning writing-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted writing-num">—</span>
        </div>

        <div class="rating-row rating-row--compact">
          <span class="rating-row__label">Groupwork</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--warning group-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted group-num">—</span>
        </div>

        <div class="rating-row rating-row--compact">
          <span class="rating-row__label">Other</span>
          <div class="rating-row__bar">
            <div class="rating-row__fill rating-row__fill--warning homework-bar" style="width: 0%"></div>
          </div>
          <span class="rating-row__value rating-row__value--muted homework-num">—</span>
        </div>
      </div>
    </div>
    
    <!-- Grades Panel -->
    <div class="grades-panel">
      <div class="grades-panel__header">
        <h2 class="grades-panel__title">Grade Distribution</h2>
        <div class="grades-panel__toggle">
           <button id="toggle-chart-type" class="btn-sm btn-outline">Switch to Bar</button>
        </div>
      </div>
      
      <div class="grades-panel__chart-container">
        <canvas id="gradesChart"></canvas>
        <div id="grades-empty" class="grades-panel__empty" style="display: none;">
          <svg class="grades-panel__empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 15h8"></path>
            <path d="M9 9h.01"></path>
            <path d="M15 9h.01"></path>
          </svg>
          <p>No grade data available</p>
        </div>
      </div>
      <div class="grades-panel__summary">
        <div class="grades-metric">
          <span class="grades-metric__label">Average GPA</span>
          <span class="grades-metric__value" id="average-gpa-value">—</span>
        </div>
        <div class="grades-metric">
          <span class="grades-metric__label">Students Measured</span>
          <span class="grades-metric__value" id="grade-sample-size">—</span>
        </div>
      </div>
    </div>

    <!-- Sections Panel -->
    {% if display_times and sections_count %}
    <div class="sections-panel">
      <div class="sections-panel__header">
        <h2 class="sections-panel__title">Sections</h2>
        <span class="sections-panel__count">{{ sections_count }}</span>
      </div>

      <div class="sections-panel__list">
        {% if lecture_sections %}
        <div class="sections-panel__group">
          <h3 class="sections-panel__group-title">Lecture ({{ lecture_sections|length }})</h3>
          {% for section in lecture_sections %}
          {% include "site/components/_section_card.html" with section=section sem_code=sem_code %}
          {% endfor %}
        </div>
        {% endif %}

        {% if other_sections %}
        <div class="sections-panel__group">
          <h3 class="sections-panel__group-title">Other Sections ({{ other_sections|length }})</h3>
          {% for section in other_sections %}
          {% include "site/components/_section_card.html" with section=section sem_code=sem_code %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  
  <!-- In-Article Ad between stats and reviews -->
  {% include "site/components/_in_article_ad.html" %}

  <section class="reviews-section" id="reviews">
    <div class="reviews-header">
      <h2 class="reviews-header__title">{{ num_reviews }} Review{{ num_reviews|pluralize }}</h2>

      <div class="reviews-header__actions">
        {% if user.is_authenticated %}
        <a href="{% url 'new_review' %}?course={{ course.id }}&instructor={{ instructor.id }}" class="btn btn--primary btn--md add-review-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Review
        </a>
        {% else %}
        <a href="#" class="btn btn--primary btn--md add-review-btn" data-action="login">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Review
        </a>
        {% endif %}

        {% if paginated_reviews and num_reviews > 0 %}
        <select class="select reviews-sort-select" id="review-sort" aria-label="Sort reviews">
          <option value="">Sort by...</option>
          <option value="Most Helpful" {% if sort_method == "Most Helpful" %}selected{% endif %}>Most Helpful</option>
          <option value="Most Recent" {% if sort_method == "Most Recent" %}selected{% endif %}>Most Recent</option>
          <option value="Highest Rating" {% if sort_method == "Highest Rating" %}selected{% endif %}>Highest Rating</option>
          <option value="Lowest Rating" {% if sort_method == "Lowest Rating" %}selected{% endif %}>Lowest Rating</option>
        </select>
        {% endif %}
      </div>
    </div>

    <div id="reviews-results">
    {% if paginated_reviews and num_reviews > 0 %}
    {% for review in paginated_reviews %}
    <article class="review-card">
      <div class="review-card__header">
        <div class="review-card__meta">
          <span class="review-card__semester">{{ review.semester }}</span>
          {% if review.grade %}
          <span>Grade: {{ review.grade }}</span>
          {% endif %}
        </div>

        <div class="review-card__ratings">
          <div class="review-rating">
            <div class="review-rating__value">{{ review.average|floatformat:1 }}</div>
            <div class="review-rating__label">Average</div>
          </div>
        </div>
      </div>

      {% if review.text %}
      <p class="review-card__text">{{ review.text }}</p>
      {% endif %}

      <div class="review-card__category-grid">
        <div class="review-category">
          <span class="review-category__label">Instructor</span>
          <span class="review-category__value">{{ review.instructor_rating|floatformat:1 }}</span>
        </div>
        <div class="review-category">
          <span class="review-category__label">Enjoyability</span>
          <span class="review-category__value">{{ review.enjoyability|floatformat:1 }}</span>
        </div>
        <div class="review-category">
          <span class="review-category__label">Recommend</span>
          <span class="review-category__value">{{ review.recommendability|floatformat:1 }}</span>
        </div>
        <div class="review-category">
          <span class="review-category__label">Difficulty</span>
          <span class="review-category__value">{{ review.difficulty|floatformat:1 }}</span>
        </div>
        <div class="review-category">
          <span class="review-category__label">Hours/Week</span>
          <span class="review-category__value">{{ review.hours_per_week|floatformat:1 }}</span>
        </div>
      </div>

      <div class="review-card__footer">
        <div class="review-card__votes">
          <button class="vote-btn {% if review.user_vote > 0 %}is-active{% endif %}"
                  type="button"
                  data-action="upvote"
                  data-review="{{ review.id }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m5 15 7-7 7 7"/>
            </svg>
            <span>{{ review.sum_votes|default:0 }}</span>
          </button>
          <button class="vote-btn {% if review.user_vote < 0 %}is-active{% endif %}"
                  type="button"
                  data-action="downvote"
                  data-review="{{ review.id }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m19 9-7 7-7-7"/>
            </svg>
          </button>
        </div>

        <span class="review-card__date">{{ review.created }}</span>
      </div>
    </article>
    {% if forloop.counter == 3 and not forloop.last %}
    {% include "site/components/_in_feed_ad.html" %}
    {% endif %}
    {% endfor %}

    {% if paginated_reviews.has_other_pages %}
    <nav class="pagination">
      {% if paginated_reviews.has_previous %}
      <a href="?page={{ paginated_reviews.previous_page_number }}{% if sort_method and sort_method != 'Default' %}&sort={{ sort_method|urlencode }}{% endif %}#reviews" class="pagination__item">← Previous</a>
      {% endif %}

      <span class="pagination__item pagination__status">
        Page {{ paginated_reviews.number }} of {{ paginated_reviews.paginator.num_pages }}
      </span>

      {% if paginated_reviews.has_next %}
      <a href="?page={{ paginated_reviews.next_page_number }}{% if sort_method and sort_method != 'Default' %}&sort={{ sort_method|urlencode }}{% endif %}#reviews" class="pagination__item">Next →</a>
      {% endif %}
    </nav>
    {% endif %}
    {% else %}
    <div class="reviews-empty">
      <svg class="reviews-empty__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <h3 class="reviews-empty__title">No reviews yet</h3>
      <p class="reviews-empty__text">Be the first to share your experience with this course!</p>
      {% if user.is_authenticated %}
      <a href="{% url 'new_review' %}?course={{ course.id }}&instructor={{ instructor.id }}" class="btn btn--primary btn--md add-review-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Review
      </a>
      {% else %}
      <a href="#" class="btn btn--primary btn--md add-review-btn" data-action="login">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Sign in to Add Review
      </a>
      {% endif %}
    </div>
    {% endif %}
    </div>
  </section>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/site/review_votes.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1"></script>
<script>
// Sort dropdown
const sortSelect = document.getElementById('review-sort');
const reviewsResults = document.getElementById('reviews-results');
if (sortSelect) {
  sortSelect.addEventListener('change', async (e) => {
    if (!reviewsResults) {
      return;
    }

    const selectedMethod = e.target.value;
    const url = new URL(window.location.href);
    url.searchParams.delete('page');
    if (selectedMethod && selectedMethod !== 'Default') {
      url.searchParams.set('sort', selectedMethod);
    } else {
      url.searchParams.delete('sort');
    }
    url.hash = 'reviews';

    sortSelect.disabled = true;
    try {
      const response = await fetch(url.pathname + url.search, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error('Failed to load sorted reviews.');
      }

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const nextResults = doc.getElementById('reviews-results');
      if (!nextResults) {
        throw new Error('Missing reviews content.');
      }

      reviewsResults.innerHTML = nextResults.innerHTML;
      history.replaceState({}, '', url.pathname + url.search + '#reviews');

      if (window.reviewVotes && typeof window.reviewVotes.init === 'function') {
        window.reviewVotes.init();
      }
    } catch (error) {
      window.location.href = url.pathname + url.search + '#reviews';
    } finally {
      sortSelect.disabled = false;
    }
  });
}

// Load ratings data and grades
const data = JSON.parse('{{ data|escapejs }}');
if (data) {
  const averageGpaValue = document.getElementById('average-gpa-value');
  const gradeSampleSize = document.getElementById('grade-sample-size');
  if (averageGpaValue) {
    averageGpaValue.textContent = Number.isFinite(data.average_gpa)
      ? data.average_gpa.toFixed(2)
      : '—';
  }
  if (gradeSampleSize) {
    gradeSampleSize.textContent = Number.isFinite(data.total_enrolled)
      ? data.total_enrolled
      : '—';
  }

  // Ratings Bars
  const ratings = [
    { key: 'instructor', bar: '.instructor-bar', num: '.instructor-num' },
    { key: 'enjoyability', bar: '.fun-bar', num: '.fun-num' },
    { key: 'difficulty', bar: '.difficulty-bar', num: '.difficulty-num' },
    { key: 'recommendability', bar: '.recommend-bar', num: '.recommend-num' },
  ];
  
  ratings.forEach(({ key, bar, num }) => {
    const value = Number(data[key]);
    if (!Number.isFinite(value)) {
      return;
    }

    const barEl = document.querySelector(bar);
    const numEl = document.querySelector(num);
    if (!barEl || !numEl) {
      return;
    }

    barEl.style.width = Math.max(0, Math.min(100, (value / 5) * 100)) + '%';
    numEl.textContent = value.toFixed(1);
    numEl.classList.remove('rating-row__value--muted');
  });

  const workloadRows = [
    { key: 'amount_reading', bar: '.reading-bar', num: '.reading-num' },
    { key: 'amount_writing', bar: '.writing-bar', num: '.writing-num' },
    { key: 'amount_group', bar: '.group-bar', num: '.group-num' },
    { key: 'amount_homework', bar: '.homework-bar', num: '.homework-num' },
  ];
  const totalHours = Number(data.hours);
  const totalHoursEl = document.querySelector('.hours-num');
  if (totalHoursEl && Number.isFinite(totalHours)) {
    totalHoursEl.textContent = totalHours.toFixed(1);
    totalHoursEl.classList.remove('rating-row__value--muted');
  }

  workloadRows.forEach(({ key, bar, num }) => {
    const value = Number(data[key]);
    if (!Number.isFinite(value)) {
      return;
    }

    const barEl = document.querySelector(bar);
    const numEl = document.querySelector(num);
    if (!barEl || !numEl) {
      return;
    }

    if (Number.isFinite(totalHours) && totalHours > 0) {
      barEl.style.width = Math.max(0, Math.min(100, (value / totalHours) * 100)) + '%';
    }
    numEl.textContent = value.toFixed(1);
    numEl.classList.remove('rating-row__value--muted');
  });

  // Grades Chart
  const gradeKeys = ['a_plus', 'a', 'a_minus', 'b_plus', 'b', 'b_minus', 'c_plus', 'c', 'c_minus', 'dfw'];
  const gradeLabels = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'DFW'];
  const gradeValues = gradeKeys.map(k => data[k] || 0);
  const totalGrades = gradeValues.reduce((a, b) => a + b, 0);

  if (totalGrades > 0) {
    const ctx = document.getElementById('gradesChart').getContext('2d');
    let chartType = 'pie';
    
    // Check local storage for preference
    if (localStorage.getItem('chartType')) {
        chartType = localStorage.getItem('chartType');
        const toggleBtn = document.getElementById('toggle-chart-type');
        if (toggleBtn) {
            toggleBtn.textContent = chartType === 'pie' ? 'Switch to Bar' : 'Switch to Pie';
        }
    }

    let chart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: gradeLabels,
        datasets: [{
          data: gradeValues,
          backgroundColor: [
            '#22c55e', '#4ade80', '#86efac', // Greens
            '#facc15', '#fde047', '#fef08a', // Yellows
            '#fb923c', '#fdba74', // Oranges
            '#f87171', '#ef4444'  // Reds/DFW
          ],
          borderWidth: 1,
          borderColor: document.documentElement.getAttribute('data-theme') === 'dark' ? '#1f2937' : '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: chartType === 'pie',
            position: 'right'
          }
        },
        scales: {
            y: {
                display: chartType === 'bar',
                beginAtZero: true
            },
            x: {
                display: chartType === 'bar'
            }
        }
      }
    });

    // Toggle button logic
    const toggleBtn = document.getElementById('toggle-chart-type');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
            const newType = chart.config.type === 'pie' ? 'bar' : 'pie';
            chart.destroy();
            chart = new Chart(ctx, {
                type: newType,
                data: {
                    labels: gradeLabels,
                    datasets: [{
                        data: gradeValues,
                        backgroundColor: [
                            '#22c55e', '#4ade80', '#86efac', 
                            '#facc15', '#fde047', '#fef08a', 
                            '#fb923c', '#fdba74', 
                            '#f87171', '#ef4444'
                        ],
                        borderWidth: 1,
                        borderColor: document.documentElement.getAttribute('data-theme') === 'dark' ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: newType === 'pie',
                            position: 'right'
                        }
                    },
                    scales: {
                        y: {
                            display: newType === 'bar',
                            beginAtZero: true
                        },
                        x: {
                            display: newType === 'bar'
                        }
                    }
                }
            });
            toggleBtn.textContent = newType === 'pie' ? 'Switch to Bar' : 'Switch to Pie';
            localStorage.setItem('chartType', newType);
        });
    }
  } else {
    document.getElementById('gradesChart').style.display = 'none';
    document.querySelector('.grades-panel__chart-container').style.height = 'auto';
    document.getElementById('grades-empty').style.display = 'flex';
    const toggle = document.querySelector('.grades-panel__toggle');
    if (toggle) toggle.style.display = 'none';
  }
}
</script>
{% endblock %}
