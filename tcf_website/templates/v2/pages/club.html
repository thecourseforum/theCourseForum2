{% extends "v2/base.html" %}
{% load static %}

{% block title %}{{ club.name }} | theCourseForum{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/v2/pages/course_instructor.css' %}">
<link rel="stylesheet" href="{% static 'css/v2/pages/club.css' %}">
{% endblock %}

{% block content %}
<div class="club-header">
  <div class="club-header__inner">
    <nav class="breadcrumb" aria-label="Breadcrumb">
      {% for crumb in breadcrumbs %}
      {% if crumb.2 %}
      <span class="breadcrumb__current">{{ crumb.0 }}</span>
      {% else %}
      <a href="{{ crumb.1 }}" class="breadcrumb__link">{{ crumb.0 }}</a>
      <span class="breadcrumb__separator">/</span>
      {% endif %}
      {% endfor %}
    </nav>

    <div class="club-header__title-row">
      <h1 class="club-header__title">{{ club.name }}</h1>
      <span class="club-header__category">{{ club.category.name }}</span>
    </div>
  </div>
</div>

<div class="club-content">
  <section class="club-description-card">
    <div class="club-description-card__main">
      <h2 class="club-description-card__title">Club Description</h2>
      <p class="club-description-card__text">
        {% if club.description %}
        {{ club.description }}
        {% else %}
        No club description available.
        {% endif %}
      </p>

      <div class="club-meta">
        {% if club.meeting_time %}
        <span class="club-meta__item">Meeting Time: {{ club.meeting_time }}</span>
        {% endif %}
        <span class="club-meta__badge {% if club.application_required %}club-meta__badge--warning{% else %}club-meta__badge--success{% endif %}">
          {% if club.application_required %}Application Required{% else %}No Application Required{% endif %}
        </span>
      </div>
    </div>

    {% if club.photo_url %}
    <div class="club-description-card__media">
      <img src="{{ club.photo_url }}" alt="{{ club.name }}" class="club-photo">
    </div>
    {% endif %}
  </section>

  <section class="club-reviews" id="reviews">
    <div class="reviews-header">
      <h2 class="reviews-header__title">{{ num_reviews }} Review{{ num_reviews|pluralize }}</h2>

      <div class="reviews-header__actions">
        {% if user.is_authenticated %}
        <a href="{% url 'new_review_v2' %}?mode=clubs&club={{ club.id }}" class="btn btn--primary btn--md add-review-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Review
        </a>
        {% else %}
        <a href="#" class="btn btn--primary btn--md add-review-btn" data-action="login">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Review
        </a>
        {% endif %}

        {% if paginated_reviews and num_reviews > 0 %}
        <select class="select reviews-sort-select" id="review-sort" aria-label="Sort reviews">
          <option value="">Sort by...</option>
          <option value="Most Helpful" {% if sort_method == "Most Helpful" %}selected{% endif %}>Most Helpful</option>
          <option value="Most Recent" {% if sort_method == "Most Recent" %}selected{% endif %}>Most Recent</option>
          <option value="Highest Rating" {% if sort_method == "Highest Rating" %}selected{% endif %}>Highest Rating</option>
          <option value="Lowest Rating" {% if sort_method == "Lowest Rating" %}selected{% endif %}>Lowest Rating</option>
        </select>
        {% endif %}
      </div>
    </div>

    <div id="reviews-results">
      {% if paginated_reviews and num_reviews > 0 %}
      {% for review in paginated_reviews %}
      <article class="review-card">
        <div class="review-card__header">
          <div class="review-card__meta">
            <span class="review-card__semester">{{ review.semester }}</span>
          </div>

          <div class="review-card__ratings">
            <div class="review-rating">
              <div class="review-rating__value">{{ review.average|floatformat:1 }}</div>
              <div class="review-rating__label">Average</div>
            </div>
          </div>
        </div>

        {% if review.text %}
        <p class="review-card__text">{{ review.text }}</p>
        {% endif %}

        <div class="review-card__category-grid">
          <div class="review-category">
            <span class="review-category__label">Leadership</span>
            <span class="review-category__value">{{ review.instructor_rating|floatformat:1 }}</span>
          </div>
          <div class="review-category">
            <span class="review-category__label">Enjoyability</span>
            <span class="review-category__value">{{ review.enjoyability|floatformat:1 }}</span>
          </div>
          <div class="review-category">
            <span class="review-category__label">Recommend</span>
            <span class="review-category__value">{{ review.recommendability|floatformat:1 }}</span>
          </div>
          <div class="review-category">
            <span class="review-category__label">Commitment</span>
            <span class="review-category__value">{{ review.difficulty|floatformat:1 }}</span>
          </div>
          <div class="review-category">
            <span class="review-category__label">Hours/Week</span>
            <span class="review-category__value">{{ review.hours_per_week|floatformat:1 }}</span>
          </div>
        </div>

        <div class="review-card__footer">
          <div class="review-card__votes">
            <button class="vote-btn {% if review.user_vote > 0 %}is-active{% endif %}"
                    type="button"
                    data-action="upvote"
                    data-review="{{ review.id }}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m5 15 7-7 7 7"/>
              </svg>
              <span>{{ review.sum_votes|default:0 }}</span>
            </button>
            <button class="vote-btn {% if review.user_vote < 0 %}is-active{% endif %}"
                    type="button"
                    data-action="downvote"
                    data-review="{{ review.id }}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m19 9-7 7-7-7"/>
              </svg>
            </button>
          </div>

          <span class="review-card__date">{{ review.created }}</span>
        </div>
      </article>
      {% endfor %}

      {% if paginated_reviews.has_other_pages %}
      <nav class="pagination">
        {% if paginated_reviews.has_previous %}
        <a href="?page={{ paginated_reviews.previous_page_number }}{% if sort_method %}&sort={{ sort_method|urlencode }}{% endif %}#reviews" class="pagination__item">← Previous</a>
        {% endif %}

        <span class="pagination__item pagination__status">
          Page {{ paginated_reviews.number }} of {{ paginated_reviews.paginator.num_pages }}
        </span>

        {% if paginated_reviews.has_next %}
        <a href="?page={{ paginated_reviews.next_page_number }}{% if sort_method %}&sort={{ sort_method|urlencode }}{% endif %}#reviews" class="pagination__item">Next →</a>
        {% endif %}
      </nav>
      {% endif %}
      {% else %}
      <div class="reviews-empty">
        <svg class="reviews-empty__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <h3 class="reviews-empty__title">No reviews yet</h3>
        <p class="reviews-empty__text">Be the first to share your experience with this club!</p>
      </div>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/v2/review_votes.js' %}"></script>
<script>
const sortSelect = document.getElementById('review-sort');
const reviewsResults = document.getElementById('reviews-results');
if (sortSelect) {
  sortSelect.addEventListener('change', async (e) => {
    if (!reviewsResults) {
      return;
    }

    const selectedMethod = e.target.value;
    const url = new URL(window.location.href);
    url.searchParams.delete('page');
    if (selectedMethod) {
      url.searchParams.set('sort', selectedMethod);
    } else {
      url.searchParams.delete('sort');
    }
    url.hash = 'reviews';

    sortSelect.disabled = true;
    try {
      const response = await fetch(url.pathname + url.search, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error('Failed to load sorted reviews.');
      }

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const nextResults = doc.getElementById('reviews-results');
      if (!nextResults) {
        throw new Error('Missing reviews content.');
      }

      reviewsResults.innerHTML = nextResults.innerHTML;
      history.replaceState({}, '', url.pathname + url.search + '#reviews');

      if (window.reviewVotes && typeof window.reviewVotes.init === 'function') {
        window.reviewVotes.init();
      }
    } catch (error) {
      window.location.href = url.pathname + url.search + '#reviews';
    } finally {
      sortSelect.disabled = false;
    }
  });
}
</script>
{% endblock %}
