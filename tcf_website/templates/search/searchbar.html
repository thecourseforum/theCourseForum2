<!-- tCF search -->
<!-- To be imported into templates (navbar, landing page) -->
<!-- Update your search form -->

<head>
  <style>
    .autocomplete-result {
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }

    .autocomplete-result:hover {
      background-color: #f0f0f0;
      color: #333;
    }

    .search-results {
      width: auto;
    }
  </style>
</head>
<form class="form-inline flex-grow-1" action="/search" method="get">
  <div class="input-group flex-grow-1" style="position: relative;">
    <input id="search-input" type="search" class="form-control border border-right-0"
      placeholder="Search for a class or professor..." aria-label="Search" name="q" value="{{query}}">
    <div class="input-group-append">
      <button class="btn btn-outline-secondary border border-left-0" id="search-button" type="submit">
        <i class="fa fa-search" aria-hidden="true"></i>
      </button>
    </div>
    <div class="search-results" id="autocomplete-results" style="
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      text-align: left;
      z-index: 1000;
      background: rgb(255, 255, 255);
      box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
    "></div>
  </div>
</form>


<script>
  var autocompleteResults = document.getElementById('autocomplete-results');
  var searchInput = document.getElementById("search-input");
  var latestRequestTime, currentRequestTime;

  function adjustAutocompleteWidth() {
    var searchInputWidth = searchInput.offsetWidth;

    var autocompleteWidth = searchInputWidth
    autocompleteResults.style.width = autocompleteWidth + 'px';
  }


  document.addEventListener('DOMContentLoaded', function () {

    adjustAutocompleteWidth();

    searchInput.addEventListener('input', adjustAutocompleteWidth);
    window.addEventListener('resize', adjustAutocompleteWidth);

    searchInput.addEventListener('input', function () {
      var latestRequestTime = Date.now();
      currentRequestTime = latestRequestTime;
      var query = searchInput.value;

      debounceTimeout = setTimeout(function () {
        if (query.length >= 1) {
          fetch('/autocomplete/?q=' + encodeURIComponent(query))
            .then(response => response.json())
            .then(data => {
              if (data && Array.isArray(data.results) && currentRequestTime == latestRequestTime) {
                displayAutocompleteResults(data.results);
              }
            })
            .catch(error => console.error('Error:', error));
        } else {
          autocompleteResults.innerHTML = '';
        }
      }, 50);
    });
  });

  function displayAutocompleteResults(results) {
    console.log(results);
    autocompleteResults.innerHTML = '';

    if (results.length === 0) {
      autocompleteResults.innerHTML = '<div class="autocomplete-result">No results found</div>';
      return;
    }

    results.forEach(function (result) {
      var resultElement = document.createElement('div');
      resultElement.classList.add('autocomplete-result');
      resultElement.setAttribute('tabindex', '0');
      resultElement.textContent = result.title;
      resultElement.addEventListener('click', function () {
        searchInput.value = result.title;
        autocompleteResults.innerHTML = '';
        searchInput.form.submit();
      });
      autocompleteResults.appendChild(resultElement);
    });
  }
</script>